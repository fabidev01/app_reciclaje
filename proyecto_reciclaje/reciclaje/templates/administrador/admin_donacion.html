{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registros de Reciclaje</title>
  <link rel="stylesheet" href="{% static 'css/administrador.css' %}" />
</head>
<body class="dashboard-body">
  <header class="dashboard-header">
    <h1>Bienvenido, Admin</h1>
    <nav>
      <a href="{% url 'admin_panel' %}">Inicio</a>
      <a href="{% url 'admin_usuarios' %}">Ver Usuarios</a>
      <a href="{% url 'admin_registros' %}">Ver Registros</a>
      <a href="{% url 'admin_catalogo' %}">Ver Cat√°logos</a>
      <a href="{% url 'admin_donacion' %}">Ver Donaciones</a>
      <a href="{% url 'admin_historial' %}">Historial de Acceso</a>
      <select name="lista-bitacora-menu" id="lista-bitacora-menu" onchange="redirigirBitacora(this.value)">
        <option value="#">Bit√°coras ‚Üì</option>
        <option value="{% url 'bitacora_reciclaje' %}">Bit√°cora Reciclaje</option>
        <option value="{% url 'bitacora_catalogo' %}">Bit√°cora de Cat√°logo</option>
        <option value="{% url 'bitacora_canje' %}">Bit√°cora de Canje</option>
      </select>
      <a href="{% url 'logout' %}">Cerrar Sesi√≥n</a>
    </nav>
  </header>

  <main class="admin-donacion-main">
    {% if messages %}
      {% for message in messages %}
        <div class="admin-donacion-message admin-donacion-message-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}
    <h2>Gesti√≥n de Donaciones</h2>
    <div class="admin-donacion-table-scroll">
      <table class="admin-donacion-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Puntos Coste</th>
            <th>Disponible</th>
            <th>Stock</th>
            <th>Descuento</th>
            <th>Categor√≠a</th>
            <th>Acci√≥n</th>
          </tr>
        </thead>
        <tbody>
          {% for donacion in donaciones %}
            <tr>
              <td>{{ donacion.0 }}</td>
              <td>{{ donacion.1 }}</td>
              <td>{{ donacion.2 }}</td>
              <td>{{ donacion.3|yesno:"S√≠,No" }}</td>
              <td>{{ donacion.4 }}</td>
              <td>{{ donacion.5 }}</td>
              <td>{{ donacion.6 }}</td>
              <td>
                <button class="admin-donacion-edit-btn" onclick="openEditModal('{{ donacion.0 }}', '{{ donacion.1|escapejs }}', '{{ donacion.2 }}', {{ donacion.3|yesno:"true,false" }}, '{{ donacion.4 }}', '{{ donacion.5 }}', '{{ donacion.6|escapejs }}')">‚úèÔ∏è</button>
                <form method="post" action="{% url 'admin_donacion' %}" style="display:inline;">
                  {% csrf_token %}
                  <input type="hidden" name="id_donacion" value="{{ donacion.0 }}">
                  <input type="hidden" name="action" value="delete">
                  <button type="submit" class="admin-donacion-delete-btn" onclick="return confirm('¬øEst√°s seguro de eliminar esta donaci√≥n?')">üóëÔ∏è</button>
                </form>
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="8">Sin donaciones registradas.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="admin-donacion-add-button-container">
      <button class="admin-donacion-add-btn" onclick="openAddModal()">A√±adir Donaci√≥n</button>
    </div>

    <!-- Modal para edici√≥n -->
    <div id="adminDonacionEditModal" class="admin-donacion-modal">
      <div class="admin-donacion-modal-content">
        <span class="admin-donacion-close-btn" onclick="closeEditModal()">√ó</span>
        <h2>Editar Donaci√≥n</h2>
        <form id="adminDonacionEditForm" method="post" action="{% url 'admin_donacion' %}">
          {% csrf_token %}
          <input type="hidden" name="id_donacion" id="adminDonacionEditId">

          <!-- Campo para el nombre -->
          <label for="adminDonacionEditNombre">Nombre:</label>
          <input type="text" name="nombre" id="adminDonacionEditNombre" required />

          <!-- Campo para el costo -->
          <label for="adminDonacionEditPuntosCoste">Puntos Coste:</label>
          <input type="number" name="puntos_coste" id="adminDonacionEditPuntosCoste" min="0" required />

          <!-- Campo para disponible -->
          <label for="adminDonacionEditDisponible">Disponible:</label>
          <input type="checkbox" name="disponible" id="adminDonacionEditDisponible" />

          <!-- Campo para el stock -->
          <label for="adminDonacionEditStock">Stock:</label>
          <input type="number" name="stock" id="adminDonacionEditStock" min="0" required />

          <!-- Campo para el descuento -->
          <label for="adminDonacionEditDescuento">Descuento:</label>
          <input type="number" name="descuento" id="adminDonacionEditDescuento" step="0.1" min="0" required />

          <!-- Campo para la categor√≠a -->
          <label for="adminDonacionEditCategoria">Categor√≠a:</label>
          <select name="categoria" id="adminDonacionEditCategoria" required>
            <option value="Descuento">Descuento</option>
            <option value="Producto">Producto</option>
            <option value="Donaci√≥n">Donaci√≥n</option>
          </select>

          <button type="submit" class="admin-donacion-save-btn">Guardar Cambios</button>
        </form>
      </div>
    </div>

    <!-- Modal para a√±adir -->
    <div id="adminDonacionAddModal" class="admin-donacion-modal">
      <div class="admin-donacion-modal-content">
        <span class="admin-donacion-close-btn" onclick="closeAddModal()">√ó</span>
        <h2>A√±adir Donaci√≥n</h2>
        <form id="adminDonacionAddForm" method="post" action="{% url 'admin_donacion' %}">
          {% csrf_token %}
          <input type="hidden" name="action" value="add">

          <!-- Campo para el nombre -->
          <label for="adminDonacionAddNombre">Nombre:</label>
          <input type="text" name="nombre" id="adminDonacionAddNombre" required />

          <!-- Campo para el costo -->
          <label for="adminDonacionAddPuntosCoste">Puntos Coste:</label>
          <input type="number" name="puntos_coste" id="adminDonacionAddPuntosCoste" min="0" required />

          <!-- Campo para disponible -->
          <label for="adminDonacionAddDisponible">Disponible:</label>
          <input type="checkbox" name="disponible" id="adminDonacionAddDisponible" checked />

          <!-- Campo para el stock -->
          <label for="adminDonacionAddStock">Stock:</label>
          <input type="number" name="stock" id="adminDonacionAddStock" min="0" required />

          <!-- Campo para el descuento -->
          <label for="adminDonacionAddDescuento">Descuento:</label>
          <input type="number" name="descuento" id="adminDonacionAddDescuento" step="0.1" min="0" required />

          <!-- Campo para la categor√≠a -->
          <label for="adminDonacionAddCategoria">Categor√≠a:</label>
          <select name="categoria" id="adminDonacionAddCategoria" required>
            <option value="Descuento">Descuento</option>
            <option value="Producto">Producto</option>
            <option value="Donaci√≥n">Donaci√≥n</option>
          </select>

          <button type="submit" class="admin-donacion-save-btn">A√±adir Donaci√≥n</button>
        </form>
      </div>
    </div>

  <script>
    function openEditModal(id, nombre, puntos_coste, disponible, stock, descuento, categoria) {
      document.getElementById('adminDonacionEditId').value = id;
      document.getElementById('adminDonacionEditNombre').value = nombre || '';
      document.getElementById('adminDonacionEditPuntosCoste').value = puntos_coste || 0;
      document.getElementById('adminDonacionEditDisponible').checked = disponible === 'true';
      document.getElementById('adminDonacionEditStock').value = stock || 0;
      document.getElementById('adminDonacionEditDescuento').value = descuento || 0;
      document.getElementById('adminDonacionEditCategoria').value = categoria || '';

      const modal = document.getElementById('adminDonacionEditModal');
      modal.classList.add('active');
    }

    function closeEditModal() {
      const modal = document.getElementById('adminDonacionEditModal');
      modal.classList.remove('active');
    }

    function openAddModal() {
      document.getElementById('adminDonacionAddNombre').value = '';
      document.getElementById('adminDonacionAddPuntosCoste').value = 0;
      document.getElementById('adminDonacionAddDisponible').checked = true;
      document.getElementById('adminDonacionAddStock').value = 0;
      document.getElementById('adminDonacionAddDescuento').value = 0;
      document.getElementById('adminDonacionAddCategoria').value = 'Donaci√≥n';

      const modal = document.getElementById('adminDonacionAddModal');
      modal.classList.add('active');
    }

    function closeAddModal() {
      const modal = document.getElementById('adminDonacionAddModal');
      modal.classList.remove('active');
    }

    window.onclick = function(event) {
      const editModal = document.getElementById('adminDonacionEditModal');
      const addModal = document.getElementById('adminDonacionAddModal');
      if (event.target == editModal) editModal.classList.remove('active');
      if (event.target == addModal) addModal.classList.remove('active');
    }

    function redirigirBitacora(url) {
      if (url && url !== '#') {
        window.location.href = url;
      }
    }
  </script>
</body>
</html>